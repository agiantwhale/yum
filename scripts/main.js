function randomNumber(e){return parseInt(Math.random()*e)}function shuffle(e){for(var t,o,s=e.length-1;s;t=randomNumber(s),o=e[--s],e[s]=e[t],e[t]=o);return e}function indexOf(e,t){for(var o=0;o<e.length;o++)if(e[o]===t)return o}function deleteByValue(e,t){var o=indexOf(e,t);return e.splice(o,1)}function normalize(e,t,o){return(2*e.length+t+o)%e.length}function swap(e,t,o){if(t>e.length||o>e.length||t===o)return e;var s=e[t];return e[t]=e[o],e[o]=s,e}function Solver(e,t){this.nodes=e,this.best=null,this.currentBest=null,this.bestValue=void 0,this.currentGeneration=0,this.populationSize=t,this.crossoverProbability=.9,this.mutationProbability=.01,this.population=[],this.values=new Array(t),this.fitnesses=new Array(t),this.distances=new Array(t),this.roulette=new Array(t),this.unchangedCount=0,this.mutationCount=0}function callback(e,t){t===google.maps.places.PlacesServiceStatus.OK?$.merge(queryResults,e):console.log(t),queryCounter++}function setWindowDetails(e,t){"Loading..."===e.getContent()&&placesService.getDetails({placeId:t.place_id},function(t,o){o===google.maps.places.PlacesServiceStatus.OK?e.setContent(t.name):console.log(o)})}function addMarkerListeners(e,t,o){google.maps.event.addListener(t,"domready",function(){$(".gm-style-iw").next("div").hide()}),google.maps.event.addListener(e,"mouseover",function(){setWindowDetails(t,o),t.open(map,this)}),google.maps.event.addListener(e,"mouseout",function(){t.close()})}function setQueryWatch(){queryCounter=0,queryWatch=setInterval(function(){if(queryCounter>=queryTypes.length){clearInterval(queryWatch),$("#points").text(""+queryResults.length);var e=new google.maps.LatLngBounds;for(var t in queryResults){var o=queryResults[t];e.extend(o.geometry.location);var s=new google.maps.Marker({position:o.geometry.location,map:map,icon:{path:google.maps.SymbolPath.CIRCLE,scale:4,fillColor:"#e74c3c",strokeColor:"#e74c3c"}});markers.push(s);var n=new google.maps.InfoWindow({content:"Loading...",map:map,position:o.geometry.location,closeBoxURL:""});windows.push(n),n.close(),addMarkerListeners(s,n,o)}map.setCenter(e.getCenter()),map.fitBounds(e),startRouting()}},100)}function query(){for(var e in markers){var t=markers[e];t.setMap(null)}markers=[];for(var o in windows){var s=windows[o];s.setMap(null)}windows=[],null!==polylinePath&&polylinePath.setMap(null),setQueryWatch(),placesService=new google.maps.places.PlacesService(map);var n={location:new google.maps.LatLng(42.277323,-83.738252),radius:6e3,types:null};for(var r in queryTypes)n.types=[queryTypes[r]],placesService.radarSearch(n,callback)}function initializeMap(){var e=$("#map-canvas"),t=($("#sidebar"),{center:new google.maps.LatLng(42.277323,-83.738252),zoom:12,mapTypeControl:!1,streetViewControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP});map=new google.maps.Map(e[0],t),query()}function draw(){var e=solver.best,t=[];for(var o in e)t[o]=queryResults[e[o]].geometry.location;null!==polylinePath&&polylinePath.setMap(null);var s={path:google.maps.SymbolPath.FORWARD_CLOSED_ARROW,fillColor:"#e74c3c",strokeColor:"#e74c3c",fillOpacity:.8,strokeOpacity:.8};polylinePath=new google.maps.Polyline({path:t,strokeColor:"#e74c3c",strokeOpacity:1,strokeWeight:4,icons:[{icon:s,offset:"100%",repeat:"100px"}]}),polylinePath.setMap(map),$("#gen").text(""+solver.currentGeneration),$("#unchanged").text(""+solver.unchangedCount),$("#mutate").text(""+solver.mutationCount)}function startRouting(){solver=new Solver(queryResults,30),solver.initialize(),routeInterval=setInterval(function(){return solver.unchangedCount>20?(clearInterval(routeInterval),void draw()):(solver.nextGeneration(),void(0===solver.unchangedCount&&draw()))},50)}Solver.prototype.setBestValue=function(){for(var e=this.population.length-1;e>=0;e--)this.values[e]=this.evaluate(this.population[e]);this.currentBest=this.getCurrentBest(),void 0===this.bestValue||this.bestValue>this.currentBest.bestValue?(this.best=this.population[this.currentBest.bestIndex].slice(0),this.bestValue=this.currentBest.bestValue,this.unchangedCount=0):this.unchangedCount++},Solver.prototype.getCurrentBest=function(){for(var e=0,t=this.values[0],o=1;o<this.population.length;o++)this.values[o]<t&&(t=this.values[o],e=o);return{bestIndex:e,bestValue:t}},Solver.prototype.evaluate=function(e){for(var t=this.distances[e[0]][e[e.length-1]],o=1;o<e.length;o++)t+=this.distances[e[o]][e[o-1]];return t},Solver.prototype.randomIndividual=function(e){for(var t=[],o=0;e>o;o++)t.push(o);return shuffle(t)},Solver.prototype.initialize=function(){var e=this.nodes.length;this.distances=new Array(this.nodes.length);for(var t=0;e>t;t++){this.distances[t]=new Array(this.nodes.length);for(var o=0;e>o;o++)this.distances[t][o]=google.maps.geometry.spherical.computeDistanceBetween(this.nodes[t].geometry.location,this.nodes[o].geometry.location)}for(var s=0;s<this.populationSize;s++)this.population.push(this.randomIndividual(this.nodes.length));this.setBestValue()},Solver.prototype.nextGeneration=function(){this.currentGeneration++,this.selection(),this.crossover(),this.mutation(),this.setBestValue()},Solver.prototype.selection=function(){var e=[],t=4;e.push(this.population[this.currentBest.bestIndex]),e.push(this.doMutate(this.best.slice(0))),e.push(this.pushMutate(this.best.slice(0))),e.push(this.best.slice(0)),this.setRoulette();for(var o=t;o<this.populationSize;o++)e.push(this.population[this.wheelOut(Math.random())]);this.population=e},Solver.prototype.crossover=function(){for(var e=[],t=0;t<this.populationSize;t++)Math.random()<this.crossoverProbability&&e.push(t);e=shuffle(e);for(var t=0,o=e.length-1;o>t;t+=2)this.doCrossover(e[t],e[t+1])},Solver.prototype.doCrossover=function(e,t){var o=this.getChild(1,e,t),s=this.getChild(-1,e,t);this.population[e]=o,this.population[t]=s},Solver.prototype.getChild=function(e,t,o){var s,n,r=[],i=this.population[t].slice(0),a=this.population[o].slice(0),l=i[randomNumber(i.length)];for(r.push(l);i.length>1;)s=i[normalize(i,i.indexOf(l),e)],n=a[normalize(a,a.indexOf(l),e)],deleteByValue(i,l),deleteByValue(a,l),l=this.distances[l][s]<this.distances[l][n]?s:n,r.push(l);return r},Solver.prototype.mutation=function(){for(var e=0;e<this.populationSize;e++)Math.random()<this.mutationProbability&&(Math.random()>.5?this.population[e]=this.pushMutate(this.population[e]):this.population[e]=this.doMutate(this.population[e]),mutationCount++,e--)},Solver.prototype.doMutate=function(e){var t=0,o=0;do t=randomNumber(e.length-2),o=randomNumber(e.length);while(t>=o);for(var s=0,n=o-t+1>>1;n>s;s++)swap(e,t+s,o-s);return e},Solver.prototype.pushMutate=function(e){var t=0,o=0;do t=randomNumber(e.length>>1),o=randomNumber(e.length);while(t>=o);var s=e.slice(0,t),n=e.slice(t,o),r=e.slice(o,e.length);return n.concat(s).concat(r).slice(0)},Solver.prototype.setRoulette=function(){for(var e=0;e<this.values.length;e++)this.fitnesses[e]=1/this.values[e];for(var t=0,e=0;e<this.fitnesses.length;e++)t+=this.fitnesses[e];for(var e=0;e<this.roulette.length;e++)this.roulette[e]=this.fitnesses[e]/t;for(var e=1;e<this.roulette.length;e++)this.roulette[e]+=this.roulette[e-1]},Solver.prototype.wheelOut=function(e){var t;for(t=0;t<this.roulette.length;t++)if(e<=this.roulette[t])return t};var map=null,placesService=null,polylinePath=null,solver=null,routeInterval=null,queryCounter=0,queryResults=[],queryWatch=null,queryTypes=["cafe","restaurant"],markers=[],windows=[];google.maps.event.addDomListener(window,"load",initializeMap),$(document).ready(function(){$("#cafes").prop("checked",!0),$("#restaurants").prop("checked",!0),$("#bar").prop("checked",!1),$("#takeouts").prop("checked",!1),$("#deliveries").prop("checked",!1),$("#bakeries").prop("checked",!1),$(":checkbox").change(function(){queryTypes=[],$("#cafes").is(":checked")&&queryTypes.push("cafe"),$("#restaurants").is(":checked")&&queryTypes.push("restaurant"),$("#bars").is(":checked")&&queryTypes.push("bar"),$("#takeouts").is(":checked")&&queryTypes.push("meal_takeout"),$("#deliveries").is(":checked")&&queryTypes.push("meal_delivery"),$("#bakeries").is(":checked")&&queryTypes.push("bakery"),query()}),$("#wtf-btn").click(function(){$("#wtf").modal()})});